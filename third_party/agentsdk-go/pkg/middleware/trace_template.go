package middleware

import "html/template"

type traceTemplateData struct {
	SessionID     string
	CreatedAt     string
	UpdatedAt     string
	EventCount    int
	JSONLog       string
	TotalTokens   int
	TotalDuration int64
	EventsJSON    template.JS
}

const traceHTMLTemplate = `<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><title>Trace - {{ .SessionID }}</title><style>
:root{color-scheme:dark;}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;margin:0;background:#0b1120;color:#e2e8f0;}header{padding:20px 28px;background:#111827;box-shadow:0 2px 8px rgba(0,0,0,.4);}header h1{margin:0;font-size:22px;}header p{margin:6px 0 0;color:#94a3b8;font-size:14px;}main{padding:24px;}.stats{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:18px;}.stat-card{background:#1f2937;border-radius:10px;padding:12px 18px;border:1px solid #374151;min-width:170px;}.stat-card .label{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:#94a3b8;}.stat-card .value{font-size:22px;margin-top:4px;font-weight:600;}details{background:#111827;border-radius:10px;margin-bottom:12px;border:1px solid #1f2937;box-shadow:0 1px 3px rgba(15,23,42,.6);}details summary{cursor:pointer;padding:14px 18px;font-weight:600;display:flex;align-items:center;gap:12px;justify-content:space-between;}details[open]{border-color:#38bdf8;}.timeline-meta{font-size:13px;color:#cbd5f5;padding:0 18px 10px;display:flex;gap:18px;flex-wrap:wrap;}.json-block{background:#0f172a;border-radius:8px;margin:12px 18px 18px;padding:12px 14px;font-family:"SFMono-Regular",Consolas,monospace;font-size:13px;}.json-block details{border:none;margin:0;box-shadow:none;background:transparent;}.json-block details summary{padding:4px 0;font-size:13px;}.json-block pre{margin:0;overflow-x:auto;white-space:pre-wrap;word-break:break-word;}.badge{display:inline-flex;align-items:center;background:#334155;padding:4px 10px;border-radius:999px;font-size:12px;text-transform:uppercase;letter-spacing:.08em;}.chip{display:inline-flex;align-items:center;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:8px;}.chip-duration{background:#1d4ed8;}.chip-token{background:#047857;}.chip-error{background:#b91c1c;}.chip-input{background:#1e40af;}.chip-output{background:#15803d;}.chip-total{background:#6d28d9;}.meta-label{color:#94a3b8;}footer{padding:16px 24px;color:#64748b;font-size:13px;border-top:1px solid #1f2937;}.highlight-key{color:#fb7185;}.highlight-string{color:#34d399;}.highlight-number{color:#fbbf24;}.highlight-bool{color:#f87171;}.highlight-punct{color:#94a3b8;}.empty{color:#64748b;font-style:italic;}.alert{margin:12px 18px;padding:10px 14px;border-radius:8px;font-weight:600;}.alert-error{background:#450a0a;border:1px solid #f87171;color:#fecaca;}.usage-line{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;align-items:center;}
</style></head><body><header><h1>Trace Session: {{ .SessionID }}</h1><p>{{ .EventCount }} events Â· Started {{ .CreatedAt }} Â· Updated {{ .UpdatedAt }} Â· JSONL: {{ .JSONLog }}</p></header><main><section class="stats"><div class="stat-card"><div class="label">Total Tokens</div><div class="value">{{ .TotalTokens }}</div></div><div class="stat-card"><div class="label">Total Duration (ms)</div><div class="value">{{ .TotalDuration }}</div></div><div class="stat-card"><div class="label">Events</div><div class="value">{{ .EventCount }}</div></div></section><div id="trace-events"></div></main><footer>Generated at {{ .UpdatedAt }}</footer>
<script>
(function(){
  const events = {{ .EventsJSON }}, container = document.getElementById('trace-events');
  if (!Array.isArray(events) || !events.length) {
    const empty = document.createElement('p');
    empty.className = 'empty';
    empty.textContent = 'Trace data pending...';
    container.appendChild(empty);
    return;
  }
  const stringify = (value) => {
    if (value === null || value === undefined) return 'null';
    if (typeof value === 'string') return value;
    try { return JSON.stringify(value, null, 2); } catch (err) { return String(value); }
  };
  const highlight = (value) => {
    let text = stringify(value).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    text = text.replace(/(".*?")(?=\s*:)/g,'<span class="highlight-key">$1</span>')
      .replace(/"([^"\\]*(?:\\.[^"\\]*)*)"/g,'<span class="highlight-string">"$1"</span>')
      .replace(/\b(true|false|null)\b/g,'<span class="highlight-bool">$1</span>')
      .replace(/(-?\d+\.?\d*)/g,'<span class="highlight-number">$1</span>')
      .replace(/[{}\[\]]/g,'<span class="highlight-punct">$&</span>');
    return text;
  };
  const shouldCollapse = (label, value) => {
    if (!value) return false;
    if (/model_(request|response)|Messages|Tools|Model Config|Tool Calls/i.test(label)) return true;
    if (typeof value === 'string' && value.length > 400) return true;
    return stringify(value).length > 600;
  };
  const getTokens = (evt) => {
    const usage = evt?.model_response?.usage;
    const total = usage?.total_tokens ?? usage?.TotalTokens ?? usage?.total;
    return typeof total === 'number' ? total : 0;
  };
  const pick = (obj, key) => {
    if (!obj || typeof obj !== 'object') return undefined;
    const camel = key.replace(/_([a-z])/g, (_, c) => c.toUpperCase());
    const pascal = camel.charAt(0).toUpperCase() + camel.slice(1);
    return obj[key] ?? obj[camel] ?? obj[pascal];
  };
  const toText = (value) => {
    if (value === undefined || value === null) return '';
    if (typeof value === 'string') return value;
    if (Array.isArray(value)) {
      return value.map((entry) => typeof entry === 'string' ? entry : (entry?.text ?? stringify(entry))).join('\n---\n');
    }
    if (typeof value === 'object' && typeof value.text === 'string') return value.text;
    return stringify(value);
  };
  const appendPlain = (wrapper, label, value) => {
    if (value === undefined || value === null || value === '') return;
    const block = document.createElement('div');
    block.className = 'json-block';
    const title = document.createElement('strong');
    title.textContent = label;
    block.appendChild(title);
    const pre = document.createElement('pre');
    pre.textContent = value;
    block.appendChild(pre);
    wrapper.appendChild(block);
  };
  const renderModelRequest = (details, req) => {
    if (!req) return;
    const messages = pick(req, 'messages');
    Array.isArray(messages) && messages.length && appendBlock(details, 'ðŸ“ Messages (' + messages.length + ')', messages);
    const system = pick(req, 'system');
    system && appendBlock(details, 'ðŸ§  System Prompt', system);
    const tools = pick(req, 'tools');
    Array.isArray(tools) && tools.length && appendBlock(details, 'ðŸ”§ Tools (' + tools.length + ')', tools);
    const config = {};
    ['model','max_tokens','temperature','top_p','top_k','metadata'].forEach((key) => {
      const val = pick(req, key);
      if (val !== undefined) config[key] = val;
    });
    Object.keys(config).length && appendBlock(details, 'âš™ï¸ Model Config', config);
  };
  const renderUsage = (details, usage) => {
    if (!usage || typeof usage !== 'object') return;
    const badges = [];
    const push = (label, value, cls) => {
      if (value === undefined || value === null) return;
      const num = Number(value);
      badges.push('<span class="chip ' + cls + '">' + label + ': ' + (Number.isFinite(num) ? num : value) + '</span>');
    };
    push('input_tokens', pick(usage, 'input_tokens'), 'chip-input');
    push('output_tokens', pick(usage, 'output_tokens'), 'chip-output');
    push('total', pick(usage, 'total_tokens') ?? pick(usage, 'total'), 'chip-total');
    if (!badges.length) return;
    const block = document.createElement('div');
    block.className = 'json-block';
    block.innerHTML = '<strong>ðŸ“Š Usage</strong><div class="usage-line">' + badges.join('') + '</div>';
    details.appendChild(block);
  };
  const renderModelResponse = (details, resp) => {
    if (!resp) return;
    const content = pick(resp, 'content') ?? pick(resp, 'output');
    content !== undefined && appendPlain(details, 'Assistant Content', toText(content));
    renderUsage(details, pick(resp, 'usage'));
    const stop = pick(resp, 'stop_reason') ?? pick(resp, 'finish_reason');
    stop && appendPlain(details, 'Stop Reason', String(stop));
    const respTools = pick(resp, 'tool_calls');
    Array.isArray(respTools) && respTools.length && appendBlock(details, 'ðŸ”§ Tool Calls (' + respTools.length + ')', respTools);
  };
  const renderToolCall = (details, call) => {
    if (!call) return;
    const name = pick(call, 'name') || 'unknown';
    const id = pick(call, 'id');
    const input = pick(call, 'input') ?? pick(call, 'params');
    appendBlock(details, 'ðŸ”§ Tool Call Â· ' + name + (id ? ' (#' + id + ')' : ''), input ?? call);
  };
  const renderToolResult = (details, result) => {
    if (!result) return;
    const name = pick(result, 'name');
    const isErr = pick(result, 'is_error');
    const payload = pick(result, 'content') ?? pick(result, 'output') ?? result;
    appendBlock(details, 'Tool Result Â· ' + (name || 'unknown') + ' (' + (isErr ? 'âš ï¸ error' : 'âœ… ok') + ')', payload);
  };
  const renderError = (details, error) => {
    if (!error) return;
    const alert = document.createElement('div');
    alert.className = 'alert alert-error';
    alert.textContent = 'âš ï¸ Error: ' + error;
    details.appendChild(alert);
  };
  const appendBlock = (wrapper, label, value) => {
    if (value === undefined || value === null) return;
    const block = document.createElement('div');
    block.className = 'json-block';
    if (shouldCollapse(label, value)) {
      const detailsNode = document.createElement('details');
      detailsNode.open = false;
      const summary = document.createElement('summary');
      summary.textContent = label + ' (collapsed)';
      detailsNode.appendChild(summary);
      const pre = document.createElement('pre');
      pre.innerHTML = highlight(value);
      detailsNode.appendChild(pre);
      block.appendChild(detailsNode);
    } else {
      const title = document.createElement('strong');
      title.textContent = label;
      block.appendChild(title);
      const pre = document.createElement('pre');
      pre.innerHTML = highlight(value);
      block.appendChild(pre);
    }
    wrapper.appendChild(block);
  };
  events.forEach((evt, idx) => {
    const details = document.createElement('details');
    details.open = idx === events.length - 1;
    const summary = document.createElement('summary');
    const badges = [];
    evt.duration_ms && badges.push('<span class="chip chip-duration">' + evt.duration_ms + ' ms</span>');
    const tokens = getTokens(evt);
    tokens && badges.push('<span class="chip chip-token">' + tokens + ' tok</span>');
    evt.error && badges.push('<span class="chip chip-error">error</span>');
    summary.innerHTML = '<span class="badge">' + evt.stage + '</span> Iteration ' + evt.iteration + ' Â· ' + evt.timestamp + '<span>' + badges.join('') + '</span>';
    details.appendChild(summary);
    const meta = document.createElement('div');
    meta.className = 'timeline-meta';
    meta.innerHTML = '<div><span class="meta-label">Session:</span> ' + evt.session_id + '</div>' +
      '<div><span class="meta-label">Timestamp:</span> ' + evt.timestamp + '</div>';
    details.appendChild(meta);
    renderError(details, evt.error);
    renderModelRequest(details, evt.model_request);
    renderModelResponse(details, evt.model_response);
    renderToolCall(details, evt.tool_call);
    renderToolResult(details, evt.tool_result);
    appendBlock(details, 'Raw Input', evt.input);
    appendBlock(details, 'Raw Output', evt.output);
    container.appendChild(details);
  });
})();
</script></body></html>`
