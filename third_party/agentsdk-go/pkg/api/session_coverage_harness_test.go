package api

import (
	"flag"
	"strings"
	"testing"
)

func TestSessionCoverageHarness(t *testing.T) {
	run := flag.Lookup("test.run")
	if run == nil || run.Value.String() == "" || !strings.Contains(run.Value.String(), "TestSession") {
		t.Skip("coverage harness only runs when -run includes TestSession")
	}

	tests := []struct {
		name string
		fn   func(*testing.T)
	}{
		{"TestActivationContext", TestActivationContext},
		{"TestAdditionalSandboxPathsHandlesNilAndDedup", TestAdditionalSandboxPathsHandlesNilAndDedup},
		{"TestAdditionalSandboxPathsSkipsInvalidEntries", TestAdditionalSandboxPathsSkipsInvalidEntries},
		{"TestAllowedByManagedPoliciesPrefersDeny", TestAllowedByManagedPoliciesPrefersDeny},
		{"TestAnyToString", TestAnyToString},
		{"TestAnyToStringCoversStringer", TestAnyToStringCoversStringer},
		{"TestApplyCommandMetadata", TestApplyCommandMetadata},
		{"TestApplyCommandMetadataIgnoresNil", TestApplyCommandMetadataIgnoresNil},
		{"TestApplyPromptMetadata", TestApplyPromptMetadata},
		{"TestApplyPromptMetadataOverride", TestApplyPromptMetadataOverride},
		{"TestAtomicWriteFileCreateTempError", TestAtomicWriteFileCreateTempError},
		{"TestAtomicWriteFileRenameErrorCleansTemp", TestAtomicWriteFileRenameErrorCleansTemp},
		{"TestAvailableToolsFiltersWhitelist", TestAvailableToolsFiltersWhitelist},
		{"TestAvailableToolsNilRegistry", TestAvailableToolsNilRegistry},
		{"TestAvailableToolsReturnsDefinitions", TestAvailableToolsReturnsDefinitions},
		{"TestAvailableToolsWhitelistAllowsMatch", TestAvailableToolsWhitelistAllowsMatch},
		{"TestBuildSandboxManager", TestBuildSandboxManager},
		{"TestBuildSandboxManagerAppliesDefaultNetworkAllow", TestBuildSandboxManagerAppliesDefaultNetworkAllow},
		{"TestBuildSandboxManagerEnabledByDefault", TestBuildSandboxManagerEnabledByDefault},
		{"TestBuildSandboxManagerRespectsDisabledSetting", TestBuildSandboxManagerRespectsDisabledSetting},
		{"TestBuildSettingsHooksCreatesCorrectTypes", TestBuildSettingsHooksCreatesCorrectTypes},
		{"TestBuildSettingsHooksNil", TestBuildSettingsHooksNil},
		{"TestBuildSettingsHooksSkipsEmpty", TestBuildSettingsHooksSkipsEmpty},
		{"TestBuildSubagentsManagerHandlesEmptyAndManual", TestBuildSubagentsManagerHandlesEmptyAndManual},
		{"TestChunkString", TestChunkString},
		{"TestCloneArgumentsCopiesMap", TestCloneArgumentsCopiesMap},
		{"TestCollectMCPServersMergesSourcesAndDedups", TestCollectMCPServersMergesSourcesAndDedups},
		{"TestCombineAndPrependPrompt", TestCombineAndPrependPrompt},
		{"TestCombineToolWhitelistsIntersection", TestCombineToolWhitelistsIntersection},
		{"TestCombineToolWhitelistsNilInputs", TestCombineToolWhitelistsNilInputs},
		{"TestCompactor_CompactFlow", TestCompactor_CompactFlow},
		{"TestCompactor_HookDenySkips", TestCompactor_HookDenySkips},
		{"TestCompactor_PersistsRolloutEvent", TestCompactor_PersistsRolloutEvent},
		{"TestCompactor_RetryWithFallbackModel", TestCompactor_RetryWithFallbackModel},
		{"TestCompactor_ShouldCompactThreshold", TestCompactor_ShouldCompactThreshold},
		{"TestCompactor_SmartPreserveInitialAndUserText", TestCompactor_SmartPreserveInitialAndUserText},
		{"TestConcurrentExecution", TestConcurrentExecution},
		{"TestConversationModelEnableCachePassthrough", TestConversationModelEnableCachePassthrough},
		{"TestConversationModelGenerateNilModel", TestConversationModelGenerateNilModel},
		{"TestConversationModelGenerateTracksStateAndToolCalls", TestConversationModelGenerateTracksStateAndToolCalls},
		{"TestConvertMessagesClonesToolCalls", TestConvertMessagesClonesToolCalls},
		{"TestConvertRunResultHelpers", TestConvertRunResultHelpers},
		{"TestDefaultSessionID", TestDefaultSessionID},
		{"TestDefaultSessionIDUsesEntrypoint", TestDefaultSessionIDUsesEntrypoint},
		{"TestDefaultSubagentDefinitions", TestDefaultSubagentDefinitions},
		{"TestDefinitionSnapshotVariants", TestDefinitionSnapshotVariants},
		{"TestEnforceSandboxHostDenied", TestEnforceSandboxHostDenied},
		{"TestEnforceSandboxHostIgnoresSTDIO", TestEnforceSandboxHostIgnoresSTDIO},
		{"TestEnforceSandboxHostNoManager", TestEnforceSandboxHostNoManager},
		{"TestExecuteCommandsIgnoresPlainText", TestExecuteCommandsIgnoresPlainText},
		{"TestExecuteCommandsUnknownCommand", TestExecuteCommandsUnknownCommand},
		{"TestExecuteSubagentBranches", TestExecuteSubagentBranches},
		{"TestExecuteSubagentSuccess", TestExecuteSubagentSuccess},
		{"TestFreezeModeDeepCopy", TestFreezeModeDeepCopy},
		{"TestHistoryStoreCreatesNewSession", TestHistoryStoreCreatesNewSession},
		{"TestHistoryStoreCreatesOnce", TestHistoryStoreCreatesOnce},
		{"TestHistoryStoreEvictsOldestSession", TestHistoryStoreEvictsOldestSession},
		{"TestHistoryStoreUpdatesLRUOnAccess", TestHistoryStoreUpdatesLRUOnAccess},
		{"TestHookRecorder_CompactorUsesRequestScopedRecorder", TestHookRecorder_CompactorUsesRequestScopedRecorder},
		{"TestHookRecorder_ConcurrentRequestsAreIsolated", TestHookRecorder_ConcurrentRequestsAreIsolated},
		{"TestHookRecorder_SingleRequestCollectsHookEvents", TestHookRecorder_SingleRequestCollectsHookEvents},
		{"TestHooksDisabledFlag", TestHooksDisabledFlag},
		{"TestIntegration_RequestID_Flow", TestIntegration_RequestID_Flow},
		{"TestLoadSettingsAppliesOverrides", TestLoadSettingsAppliesOverrides},
		{"TestLoadSettingsClonesCustomLoader", TestLoadSettingsClonesCustomLoader},
		{"TestLoadSettingsErrorsOnMissingExplicitOverlay", TestLoadSettingsErrorsOnMissingExplicitOverlay},
		{"TestLoadSettingsFileIgnoresEmptyPath", TestLoadSettingsFileIgnoresEmptyPath},
		{"TestLoadSettingsFileMissingPathErrors", TestLoadSettingsFileMissingPathErrors},
		{"TestLoadSettingsMergesOverridesAndInitialisesEnv", TestLoadSettingsMergesOverridesAndInitialisesEnv},
		{"TestLoadSettingsUsesDefaultsWhenProjectConfigMissing", TestLoadSettingsUsesDefaultsWhenProjectConfigMissing},
		{"TestMatchesRuleIgnoresEmptyRule", TestMatchesRuleIgnoresEmptyRule},
		{"TestMergeCommandRegistrationsValidatesAndOverrides", TestMergeCommandRegistrationsValidatesAndOverrides},
		{"TestMergeMetadataInitializesDestination", TestMergeMetadataInitializesDestination},
		{"TestMergeSkillRegistrationsValidatesAndOverrides", TestMergeSkillRegistrationsValidatesAndOverrides},
		{"TestMergeSubagentRegistrationsValidatesAndOverrides", TestMergeSubagentRegistrationsValidatesAndOverrides},
		{"TestMergeTagsUtility", TestMergeTagsUtility},
		{"TestModelFactoryFuncModel", TestModelFactoryFuncModel},
		{"TestModelFactoryFuncNil", TestModelFactoryFuncNil},
		{"TestModelTierConstants", TestModelTierConstants},
		{"TestNewHookExecutorRegistersTypedHooks", TestNewHookExecutorRegistersTypedHooks},
		{"TestNewRejectsDisallowedMCPServer", TestNewRejectsDisallowedMCPServer},
		{"TestNewTracer_Noop", TestNewTracer_Noop},
		{"TestNewTrimmerHelper", TestNewTrimmerHelper},
		{"TestNoopSpan_Interface", TestNoopSpan_Interface},
		{"TestNoopTracer_EndSpan_Coverage", TestNoopTracer_EndSpan_Coverage},
		{"TestNoopTracer_NilSafe", TestNoopTracer_NilSafe},
		{"TestOTELConfig_Defaults", TestOTELConfig_Defaults},
		{"TestOTELConfig_Headers", TestOTELConfig_Headers},
		{"TestOTELConfig_Insecure", TestOTELConfig_Insecure},
		{"TestOptionsCompactAndTokenOptions", TestOptionsCompactAndTokenOptions},
		{"TestOptionsFrozenClonesCollections", TestOptionsFrozenClonesCollections},
		{"TestOptionsFrozenPreventsExternalMutationRaces", TestOptionsFrozenPreventsExternalMutationRaces},
		{"TestOptionsModeContext", TestOptionsModeContext},
		{"TestOptionsToolFieldsDefaultsAndPriority", TestOptionsToolFieldsDefaultsAndPriority},
		{"TestOptionsWithDefaultsPopulatesMissingFields", TestOptionsWithDefaultsPopulatesMissingFields},
		{"TestOrderedForcedSkills", TestOrderedForcedSkills},
		{"TestPermissionRequestDecisionMapping", TestPermissionRequestDecisionMapping},
		{"TestPreToolUseAllowsInputModification", TestPreToolUseAllowsInputModification},
		{"TestProgressMiddlewareEmitsLifecycleEvents", TestProgressMiddlewareEmitsLifecycleEvents},
		{"TestProgressMiddlewareNameAndEmitterGuards", TestProgressMiddlewareNameAndEmitterGuards},
		{"TestProjectConfigFromSettings", TestProjectConfigFromSettings},
		{"TestProjectConfigFromSettingsNilInput", TestProjectConfigFromSettingsNilInput},
		{"TestRegisterCommandsEmpty", TestRegisterCommandsEmpty},
		{"TestRegisterCommandsSuccess", TestRegisterCommandsSuccess},
		{"TestRegisterHelpersRejectNilHandlers", TestRegisterHelpersRejectNilHandlers},
		{"TestRegisterMCPServersDeniesUnauthorizedHost", TestRegisterMCPServersDeniesUnauthorizedHost},
		{"TestRegisterMCPServersNoop", TestRegisterMCPServersNoop},
		{"TestRegisterMCPServersNotBlockedByBuiltinWhitelist", TestRegisterMCPServersNotBlockedByBuiltinWhitelist},
		{"TestRegisterMCPServersPropagatesRegistryErrors", TestRegisterMCPServersPropagatesRegistryErrors},
		{"TestRegisterSkillsEmpty", TestRegisterSkillsEmpty},
		{"TestRegisterSkillsSuccess", TestRegisterSkillsSuccess},
		{"TestRegisterSubagentsDuplicateDefinition", TestRegisterSubagentsDuplicateDefinition},
		{"TestRegisterSubagentsEmpty", TestRegisterSubagentsEmpty},
		{"TestRegisterSubagentsRegistersHandlers", TestRegisterSubagentsRegistersHandlers},
		{"TestRegisterToolsAppendsCustomTools", TestRegisterToolsAppendsCustomTools},
		{"TestRegisterToolsDisablesAllBuiltinsWhenEmptyWhitelist", TestRegisterToolsDisablesAllBuiltinsWhenEmptyWhitelist},
		{"TestRegisterToolsFiltersDisallowedTools", TestRegisterToolsFiltersDisallowedTools},
		{"TestRegisterToolsIgnoresUnknownWhitelistEntries", TestRegisterToolsIgnoresUnknownWhitelistEntries},
		{"TestRegisterToolsLegacyToolsOverride", TestRegisterToolsLegacyToolsOverride},
		{"TestRegisterToolsRespectsEnabledWhitelist", TestRegisterToolsRespectsEnabledWhitelist},
		{"TestRegisterToolsSkipsDuplicateNames", TestRegisterToolsSkipsDuplicateNames},
		{"TestRegisterToolsSkipsNilEntries", TestRegisterToolsSkipsNilEntries},
		{"TestRegisterToolsTaskNotAddedForCI", TestRegisterToolsTaskNotAddedForCI},
		{"TestRegisterToolsUsesDefaultImplementations", TestRegisterToolsUsesDefaultImplementations},
		{"TestRegisterToolsWhitelistCaseInsensitive", TestRegisterToolsWhitelistCaseInsensitive},
		{"TestRemoveCommandLines", TestRemoveCommandLines},
		{"TestRequestModelTierOverride", TestRequestModelTierOverride},
		{"TestRequestNormalizedPopulatesDefaults", TestRequestNormalizedPopulatesDefaults},
		{"TestRequest_RequestID_AutoGenerate", TestRequest_RequestID_AutoGenerate},
		{"TestRequest_RequestID_InStruct", TestRequest_RequestID_InStruct},
		{"TestRequest_RequestID_JSON_Tag", TestRequest_RequestID_JSON_Tag},
		{"TestResolveModelPrefersFactory", TestResolveModelPrefersFactory},
		{"TestResolveProjectRootFallsBackToCWD", TestResolveProjectRootFallsBackToCWD},
		{"TestResolveProjectRootFromEnv", TestResolveProjectRootFromEnv},
		{"TestResolveProjectRootWalksUpForGoMod", TestResolveProjectRootWalksUpForGoMod},
		{"TestResponse_RequestID_InStruct", TestResponse_RequestID_InStruct},
		{"TestResponse_RequestID_JSON_Tag", TestResponse_RequestID_JSON_Tag},
		{"TestRolloutWriterWriteCompactEventMkdirError", TestRolloutWriterWriteCompactEventMkdirError},
		{"TestRolloutWriterWriteCompactEventNoopsForNilOrEmpty", TestRolloutWriterWriteCompactEventNoopsForNilOrEmpty},
		{"TestRolloutWriterWriteCompactEventWritesJSON", TestRolloutWriterWriteCompactEventWritesJSON},
		{"TestRunSerializesPreparePerSession", TestRunSerializesPreparePerSession},
		{"TestRunStreamEmitsErrorEvent", TestRunStreamEmitsErrorEvent},
		{"TestRunStreamForwardsToolStreamSink", TestRunStreamForwardsToolStreamSink},
		{"TestRunStreamProducesEvents", TestRunStreamProducesEvents},
		{"TestRunStreamRejectsEmptyPrompt", TestRunStreamRejectsEmptyPrompt},
		{"TestRunStreamRejectsEmptyPromptFallback", TestRunStreamRejectsEmptyPromptFallback},
		{"TestRuntimeAccessorsAndHooksSmoke", TestRuntimeAccessorsAndHooksSmoke},
		{"TestRuntimeCacheConfigPriority", TestRuntimeCacheConfigPriority},
		{"TestRuntimeCloseWaitsForInFlightRun", TestRuntimeCloseWaitsForInFlightRun},
		{"TestRuntimeCommandAndSkillIntegration", TestRuntimeCommandAndSkillIntegration},
		{"TestRuntimeConcurrent", TestRuntimeConcurrent},
		{"TestRuntimeHookAdapterNewEventsRecord", TestRuntimeHookAdapterNewEventsRecord},
		{"TestRuntimeHookAdapterRecordsAndIgnoresNilRecorder", TestRuntimeHookAdapterRecordsAndIgnoresNilRecorder},
		{"TestRuntimeHookAdapterRecordsEvents", TestRuntimeHookAdapterRecordsEvents},
		{"TestRuntimeHookAdapterStopNilExecutor", TestRuntimeHookAdapterStopNilExecutor},
		{"TestRuntimeLoadsSettingsFallback", TestRuntimeLoadsSettingsFallback},
		{"TestRuntimePrepare_PrecheckCompactsHistory", TestRuntimePrepare_PrecheckCompactsHistory},
		{"TestRuntimePropagatesModelError", TestRuntimePropagatesModelError},
		{"TestRuntimeRequiresModelFactory", TestRuntimeRequiresModelFactory},
		{"TestRuntimeRunSimple", TestRuntimeRunSimple},
		{"TestRuntimeRun_LongConversationCompactsAndPersists", TestRuntimeRun_LongConversationCompactsAndPersists},
		{"TestRuntimeToolExecutorEnforcesResourceLimits", TestRuntimeToolExecutorEnforcesResourceLimits},
		{"TestRuntimeToolExecutorIsAllowedRespectsWhitelists", TestRuntimeToolExecutorIsAllowedRespectsWhitelists},
		{"TestRuntimeToolExecutorPopulatesUsage", TestRuntimeToolExecutorPopulatesUsage},
		{"TestRuntimeToolExecutor_ErrorHistory", TestRuntimeToolExecutor_ErrorHistory},
		{"TestRuntimeToolFlow", TestRuntimeToolFlow},
		{"TestSafeRolloutName", TestSafeRolloutName},
		{"TestSanitizePathComponent", TestSanitizePathComponent},
		{"TestSchemaToMap", TestSchemaToMap},
		{"TestSelectModelForSubagent", TestSelectModelForSubagent},
		{"TestSelectModelForSubagentCaseInsensitive", TestSelectModelForSubagentCaseInsensitive},
		{"TestSelectModelForSubagentConcurrent", TestSelectModelForSubagentConcurrent},
		{"TestSelectModelForSubagentEmptyInputs", TestSelectModelForSubagentEmptyInputs},
		{"TestSelectModelForSubagentNilModelInPool", TestSelectModelForSubagentNilModelInPool},
		{"TestSelectModelForSubagentNoMapping", TestSelectModelForSubagentNoMapping},
		{"TestSelectModelForSubagentNoPool", TestSelectModelForSubagentNoPool},
		{"TestSelectModelForSubagentPoolTierMissing", TestSelectModelForSubagentPoolTierMissing},
		{"TestSelectModelForSubagentRequestTierNilInPool", TestSelectModelForSubagentRequestTierNilInPool},
		{"TestSettingsLoaderLoadsDisallowedTools", TestSettingsLoaderLoadsDisallowedTools},
		{"TestShouldRegisterTaskTool", TestShouldRegisterTaskTool},
		{"TestSnapshotSandboxEmpty", TestSnapshotSandboxEmpty},
		{"TestStringSlice", TestStringSlice},
		{"TestTaskRunnerContextCancellation", TestTaskRunnerContextCancellation},
		{"TestTaskRunnerConvertsSubagentErrorFlag", TestTaskRunnerConvertsSubagentErrorFlag},
		{"TestTaskRunnerDispatchesBuiltinTypes", TestTaskRunnerDispatchesBuiltinTypes},
		{"TestTaskRunnerUnknownSubagentError", TestTaskRunnerUnknownSubagentError},
		{"TestTokenStatsFromUsage", TestTokenStatsFromUsage},
		{"TestTokenTracker_Callback", TestTokenTracker_Callback},
		{"TestTokenTracker_ConcurrencySafety", TestTokenTracker_ConcurrencySafety},
		{"TestTokenTracker_NilReceiver", TestTokenTracker_NilReceiver},
		{"TestTokenTracker_RecordAndGetStats", TestTokenTracker_RecordAndGetStats},
		{"TestToolWhitelistDeniesExecution", TestToolWhitelistDeniesExecution},
		{"TestUUID_Format", TestUUID_Format},
		{"TestUUID_Uniqueness", TestUUID_Uniqueness},
		{"TestWithMaxSessionsRespectsPositiveOnly", TestWithMaxSessionsRespectsPositiveOnly},
		{"TestWithModelPool", TestWithModelPool},
		{"TestWithModelPoolNil", TestWithModelPoolNil},
		{"TestWithOTEL_Option", TestWithOTEL_Option},
		{"TestWithStreamEmitGuardsNilInputs", TestWithStreamEmitGuardsNilInputs},
		{"TestWithSubagentModelMapping", TestWithSubagentModelMapping},
		{"TestWithSubagentModelMappingNil", TestWithSubagentModelMappingNil},
	}

	for _, tc := range tests {
		tc := tc
		t.Run(tc.name, tc.fn)
	}
}
