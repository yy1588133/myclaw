name: secret-audit

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  secret-audit:
    name: secret-audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan tracked files and git history for secret leaks
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import re
          import subprocess
          import sys
          from pathlib import Path

          tracked = subprocess.check_output(['git', 'ls-files'], text=True).splitlines()

          name_pat = re.compile(r'(^|/)(\.env(\..*)?$|.*\.(pem|key|p12|pfx)$|id_rsa$|id_dsa$|credentials(\.json)?$|secrets?(\.|$)|token(\.|$)|private(_|-)key)', re.I)
          name_violations = [p for p in tracked if name_pat.search(p) and p != '.env.example']

          if name_violations:
              print('Blocked tracked sensitive filenames detected:')
              for item in name_violations:
                  print(f'  - {item}')
              sys.exit(1)

          high_conf_patterns = {
              'openai_key_like': re.compile(r'\bsk-[A-Za-z0-9]{20,}\b'),
              'github_token_like': re.compile(r'\bgh[pousr]_[A-Za-z0-9]{20,}\b'),
              'telegram_bot_token': re.compile(r'\b\d{8,10}:[A-Za-z0-9_-]{35}\b'),
              'aws_access_key': re.compile(r'\bAKIA[0-9A-Z]{16}\b'),
          }

          content_hits = []
          for rel in tracked:
              p = Path(rel)
              if not p.is_file():
                  continue
              try:
                  if p.stat().st_size > 1024 * 1024:
                      continue
                  txt = p.read_text(encoding='utf-8', errors='ignore')
              except Exception:
                  continue
              for i, line in enumerate(txt.splitlines(), 1):
                  for kind, rgx in high_conf_patterns.items():
                      if rgx.search(line):
                          content_hits.append((kind, rel, i))

          if content_hits:
              print('Blocked secret-like content detected in tracked files:')
              for kind, rel, ln in content_hits:
                  print(f'  - {kind}: {rel}:{ln}')
              sys.exit(1)

          revs = subprocess.check_output(['git', 'rev-list', '--all'], text=True).splitlines()
          history_pattern = r'sk-[A-Za-z0-9]{20,}|gh[pousr]_[A-Za-z0-9]{20,}|AKIA[0-9A-Z]{16}|\b\d{8,10}:[A-Za-z0-9_-]{35}\b'
          history_hits = set()
          chunk = 200
          for i in range(0, len(revs), chunk):
              part = revs[i:i+chunk]
              proc = subprocess.run(['git', 'grep', '-I', '-l', '-E', history_pattern, *part], text=True, capture_output=True)
              if proc.returncode not in (0, 1):
                  print('git grep history scan error:', proc.stderr.strip())
                  sys.exit(1)
              for line in proc.stdout.splitlines():
                  if line.strip():
                      history_hits.add(line.strip())

          if history_hits:
              print('Blocked secret-like content detected in git history:')
              for item in sorted(history_hits):
                  print(f'  - {item}')
              sys.exit(1)

          print('secret-audit passed')
          PY
