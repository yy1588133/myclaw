name: rollback

on:
  workflow_dispatch:
    inputs:
      target_ref:
        description: "Rollback target (branch, tag, or commit SHA)"
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  create-rollback-pr:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      TARGET_REF: ${{ github.event.inputs.target_ref }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Create rollback branch from selected target
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin --tags

          if git rev-parse --verify -q "origin/${TARGET_REF}" >/dev/null; then
            RESOLVED_REF="origin/${TARGET_REF}"
          elif git rev-parse --verify -q "${TARGET_REF}" >/dev/null; then
            RESOLVED_REF="${TARGET_REF}"
          else
            echo "Target ref not found: ${TARGET_REF}" >&2
            exit 1
          fi

          TARGET_SHA="$(git rev-parse "${RESOLVED_REF}")"
          RB_BRANCH="autolab/rollback-$(date +%Y%m%d-%H%M%S)"

          git switch -c "${RB_BRANCH}" origin/main
          git restore --source "${TARGET_SHA}" -- .

          if git diff --quiet --exit-code; then
            echo "No file diff between origin/main and ${RESOLVED_REF}. Nothing to rollback." >&2
            exit 1
          fi

          git add -A
          git commit -m "rollback: align tree to ${TARGET_REF} (${TARGET_SHA:0:12})"
          git push origin "${RB_BRANCH}"

          echo "RB_BRANCH=${RB_BRANCH}" >> "$GITHUB_ENV"
          echo "TARGET_SHA=${TARGET_SHA}" >> "$GITHUB_ENV"
          echo "RESOLVED_REF=${RESOLVED_REF}" >> "$GITHUB_ENV"

      - name: Open rollback pull request
        shell: bash
        run: |
          set -euo pipefail
          BODY="$(cat <<EOT
## Rollback target
- input: ${TARGET_REF}
- resolved: ${RESOLVED_REF}
- commit: ${TARGET_SHA}

## Notes
- Generated by rollback workflow dispatch.
- Merge strategy remains squash.
EOT
)"
          gh pr create \
            --base main \
            --head "${RB_BRANCH}" \
            --title "rollback: ${TARGET_REF}" \
            --body "${BODY}" \
            --repo "${{ github.repository }}"
